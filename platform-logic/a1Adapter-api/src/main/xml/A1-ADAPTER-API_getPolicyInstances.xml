<service-logic
    xmlns='http://www.onap.org/sdnc/svclogic'
    xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.onap.org/sdnc/svclogic ./svclogic.xsd' module='A1-ADAPTER-API' version='${project.version}'>
    <method rpc='getPolicyInstances' mode='sync'>
        <block atomic='true'>
            <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                <parameter name="level" value="info" />
                <parameter name="field1" value="Get All Policy Instance from Near RT RIC ID and Policy Type ID"/>
                <parameter name="field2" value="`$get-policy-instances-input.near-rt-ric-id`"/>
                <parameter name="field3" value="`$get-policy-instances-input.policy-type-id`"/>
            </record>
            <set>
                <parameter name='response-code' value='200' />
                <parameter name='response-message' value='getPolicyInstances executed successfully' />
            </set>
            <execute plugin='org.onap.ccsdk.sli.plugins.prop.PropertiesNode' method='readProperties' >
                <parameter name='fileName' value='/opt/onap/ccsdk/data/properties/a1-adapter-api-dg.properties' />
                <parameter name='contextPrefix' value='prop' />
            </execute>
            <switch test='`$prop.ric-plt-A1Mediator-deployed`'>
                <outcome value='true'>
                    <block atomic='true'>
                        <block atomic='true'>
                            <set>
                                <parameter name="tmp.near-rt-ric-id" value="`$get-policy-instances-input.near-rt-ric-id`"/>
                                <parameter name="tmp.policy-type-id" value="`$get-policy-instances-input.policy-type-id`"/>
                            </set>
                            <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                <parameter name="level" value="info" />
                                <parameter name="field1" value="Setting variables for A1 Adapter Get Policy Instances."/>
                                <parameter name="field2" value="`$tmp.near-rt-ric-id`"/>
                                <parameter name="field3" value="`$tmp.policy-type-id`"/>
                            </record>
                            <execute plugin='org.onap.ccsdk.sli.core.slipluginutils.SliStringUtils' method='replace' >
                                <parameter name="source" value="`$prop.restapi.policies`"/>
                                <parameter name="outputPath" value="tmp.restapi.policyinstances-url"/>
                                <parameter name="target" value="{policy_type_id}"/>
                                <parameter name="replacement" value="`$tmp.policy-type-id`"/>
                            </execute>
                            <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                <parameter name="level" value="info" />
                                <parameter name="field1" value="Setting variables for A1 Adapter Get Policy Instances."/>
                                <parameter name="field2" value="`$tmp.near-rt-ric-id`"/>
                                <parameter name="field3" value="`$tmp.policy-type-id`"/>
                                <parameter name="field4" value="`$tmp.restapi.policyinstances-url`"/>
                            </record>
                            <execute plugin='org.onap.ccsdk.sli.plugins.restapicall.RestapiCallNode' method='sendRequest' >
                                <parameter name="restapiUrl" value="`$prop.a1Mediator.url + '/' + $tmp.restapi.policyinstances-url`"/>
                                <parameter name="format" value="json"/>
                                <parameter name="httpMethod" value="GET"/>
                                <parameter name="responsePrefix" value="a1MediatorRsp"/>
                                <parameter name='contentType' value='application/json' />
                                <parameter name='accept' value='application/json' />
                                <parameter name="convertResponse" value="true"/>
                                <outcome value='success'>
                                    <block>
                                        <execute plugin='org.onap.ccsdk.sli.core.slipluginutils.SliPluginUtils' method='jsonStringToCtx'>
                                            <parameter name='source' value='a1MediatorRsp.httpResponse' />
                                            <parameter name='outputPath' value='a1MediatorPolicyInstancesList' />
                                            <parameter name='isEscaped' value='false' />
                                        </execute>
                                        <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                            <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                            <parameter name="level" value="info" />
                                            <parameter name="field1" value="List of A1 Policy Instances: "/>
                                            <parameter name="field2" value="`$a1MediatorRsp`"/>
                                        </record>
                                        <execute plugin="org.onap.ccsdk.sli.plugins.template.TemplateNode" method="evaluateTemplate" >
                                            <parameter name='templatePath' value='a1Mediator-get-policy-instances.vtl' />
                                            <parameter name='output' value='policyInstancesList' />
                                            <parameter name='prefix' value='a1-mediator' />
                                            <outcome value='success'>
                                                <block atomic='true'>
                                                    <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                                        <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                                        <parameter name="level" value="info" />
                                                        <parameter name="field1" value="__TIMESTAMP__"/>
                                                        <parameter name="field2" value="A1 Policiy Instances List"/>
                                                        <parameter name='field3' value='`$a1-mediator.policyInstancesList`' />
                                                    </record>
                                                </block>
                                            </outcome>
                                        </execute>
                                        <execute plugin='org.onap.ccsdk.sli.core.slipluginutils.SliPluginUtils' method='printContext' >
                                            <parameter name='filename' value='/opt/opendaylight/current/data/log/A1-Adapter-getPolicyInstances-context.log' />
                                        </execute>
                                        <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                            <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                            <parameter name="level" value="info" />
                                            <parameter name="field1" value="List of A1 Policy Types: "/>
                                            <parameter name="field2" value="`$a1MediatorRsp._length`"/>
                                            <parameter name="field3" value="`$a1MediatorRsp.httpResponse`"/>
                                            <parameter name="field4" value="`$a1MediatorRsp.response-code`"/>
                                            <parameter name="field5" value='`$a1MediatorRsp._length`' />
                                            <parameter name="field6" value='`$a1-mediator.policyInstancesList`' />
                                        </record>
                                    </block>
                                </outcome>
                                <outcome value='failure'>
                                    <block>
                                        <set>
                                            <parameter name='response-code' value='500'/>
                                            <parameter name='response-message' value='Seems A1 Mediator Not Healthy'/>
                                        </set>
                                        <return status='failure'>
                                            <parameter name='ack-final' value='Y'/>
                                            <parameter name="response-code" value="500" />
                                            <parameter name="response-message" value="Error in Getting A1 Policy Instances. Aborting" />
                                        </return>
                                        <block atomic='true'>
                                            <set>
                                                <parameter name='tmp.a1-adapter-api.rpc-name' value='getPolicyInstances'/>
                                                <parameter name='tmp.a1Adapter-dmaap-resp.status-code' value='`$response-code`'/>
                                                <parameter name='tmp.a1Adapter-dmaap-resp.status-value' value='`$response-message`'/>
                                                <parameter name='tmp.a1Policy-dmaap-resp.payload' value='`$a1-mediator.policyInstancesList`' />
                                            </set>
                                            <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                                <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                                <parameter name="level" value="info" />
                                                <parameter name="field1" value="__TIMESTAMP__"/>
                                                <parameter name="field2" value="Before DMAAP Event - template file name, restapiURL"/>
                                                <parameter name='field3' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                                                <parameter name='field4' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                                                <parameter name='field5' value="Status Code and Status Value to be published" />
                                                <parameter name='field6' value="`$tmp.a1Adapter-dmaap-resp.status-code`" />
                                                <parameter name='field7' value="`$tmp.a1Adapter-dmaap-resp.status-value`" />
                                                <parameter name='field8' value="A1 Adapter DMAAP Response Payload" />
                                                <parameter name='field9' value="`$tmp.a1Policy-dmaap-resp.payload`" />
                                                <parameter name='field10' value="RPC Name" />
                                                <parameter name='field11' value="`$tmp.a1-adapter-api.rpc-name`" />
                                            </record>
                                            <execute plugin='org.onap.ccsdk.sli.plugins.restapicall.RestapiCallNode' method='sendRequest' >
                                                <parameter name='templateFileName' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                                                <parameter name='restapiUrl' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                                                <parameter name='format' value='json' />
                                                <parameter name='httpMethod' value='POST' />
                                                <parameter name='contentType' value='application/json' />
                                                <parameter name='responsePrefix' value='dmaap' />
                                                <outcome value='failure'>
                                                    <block>
                                                        <return status='failure'>
                                                            <parameter name='ack-final' value='Y'/>
                                                            <parameter name="response-code" value="500" />
                                                            <parameter name="response-message" value="Error publishing DMAAP A1 Policy Response message. " />
                                                        </return>
                                                    </block>
                                                </outcome>
                                                <outcome value='success'>
                                                    <block>
                                                        <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                                            <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                                            <parameter name="level" value="info" />
                                                            <parameter name="field1" value="DMAAP A1Policy message Successfully Published "/>
                                                        </record>
                                                    </block>
                                                </outcome>
                                            </execute>
                                        </block>
                                    </block>
                                </outcome>
                            </execute>
                        </block>
                    </block>
                </outcome>
                <outcome value='false'>
                    <block>
                        <set>
                            <parameter name='response-code' value='500'/>
                            <parameter name='response-message' value='A1 Mediator Not Deployed'/>
                        </set>
                        <block atomic='true'>
                            <set>
                                <parameter name='tmp.a1-adapter-api.rpc-name' value='getPolicyInstances'/>
                                <parameter name='tmp.a1Adapter-dmaap-resp.status-code' value='`$response-code`'/>
                                <parameter name='tmp.a1Adapter-dmaap-resp.status-value' value='`$response-message`'/>
                                <parameter name='tmp.a1Policy-dmaap-resp.payload' value='`$a1-mediator.policyInstancesList`' />
                            </set>
                            <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                <parameter name="level" value="info" />
                                <parameter name="field1" value="__TIMESTAMP__"/>
                                <parameter name="field2" value="Before DMAAP Event - template file name, restapiURL"/>
                                <parameter name='field3' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                                <parameter name='field4' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                                <parameter name='field5' value="Status Code and Status Value to be published" />
                                <parameter name='field6' value="`$tmp.a1Adapter-dmaap-resp.status-code`" />
                                <parameter name='field7' value="`$tmp.a1Adapter-dmaap-resp.status-value`" />
                                <parameter name='field8' value="A1 Adapter DMAAP Response Payload" />
                                <parameter name='field9' value="`$tmp.a1Policy-dmaap-resp.payload`" />
                                <parameter name='field10' value="RPC Name" />
                                <parameter name='field11' value="`$tmp.a1-adapter-api.rpc-name`" />
                            </record>
                            <execute plugin='org.onap.ccsdk.sli.plugins.restapicall.RestapiCallNode' method='sendRequest' >
                                <parameter name='templateFileName' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                                <parameter name='restapiUrl' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                                <parameter name='format' value='json' />
                                <parameter name='httpMethod' value='POST' />
                                <parameter name='contentType' value='application/json' />
                                <parameter name='responsePrefix' value='dmaap' />
                                <outcome value='failure'>
                                    <block>
                                        <return status='failure'>
                                            <parameter name='ack-final' value='Y'/>
                                            <parameter name="response-code" value="500" />
                                            <parameter name="response-message" value="Error publishing DMAAP A1 Policy Response message. " />
                                        </return>
                                    </block>
                                </outcome>
                                <outcome value='success'>
                                    <block>
                                        <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                            <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                            <parameter name="level" value="info" />
                                            <parameter name="field1" value="DMAAP A1Policy message Successfully Published "/>
                                        </record>
                                    </block>
                                </outcome>
                            </execute>
                        </block>
                        <return status='failure'>
                            <parameter name='ack-final' value='Y'/>
                            <parameter name="response-code" value="500" />
                            <parameter name="response-message" value="Error in Getting A1 Policy Instances. Aborting" />
                        </return>
                    </block>
                </outcome>
            </switch>
            <block>
                <block atomic='true'>
                    <set>
                        <parameter name='tmp.a1-adapter-api.rpc-name' value='getPolicyInstances'/>
                        <parameter name='tmp.a1Adapter-dmaap-resp.status-code' value='`$response-code`'/>
                        <parameter name='tmp.a1Adapter-dmaap-resp.status-value' value='`$response-message`'/>
                        <parameter name='tmp.a1Policy-dmaap-resp.payload' value='`$a1-mediator.policyInstancesList`' />
                    </set>
                    <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                        <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                        <parameter name="level" value="info" />
                        <parameter name="field1" value="__TIMESTAMP__"/>
                        <parameter name="field2" value="Before DMAAP Event - template file name, restapiURL"/>
                        <parameter name='field3' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                        <parameter name='field4' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                        <parameter name='field5' value="Status Code and Status Value to be published" />
                        <parameter name='field6' value="`$tmp.a1Adapter-dmaap-resp.status-code`" />
                        <parameter name='field7' value="`$tmp.a1Adapter-dmaap-resp.status-value`" />
                        <parameter name='field8' value="A1 Adapter DMAAP Response Payload" />
                        <parameter name='field9' value="`$tmp.a1Policy-dmaap-resp.payload`" />
                        <parameter name='field10' value="RPC Name" />
                        <parameter name='field11' value="`$tmp.a1-adapter-api.rpc-name`" />
                    </record>
                    <execute plugin='org.onap.ccsdk.sli.plugins.restapicall.RestapiCallNode' method='sendRequest' >
                        <parameter name='templateFileName' value="`$prop.restapi.templateDir + '/' +  $prop.restapi.dmaap-publish-generic-response.template`" />
                        <parameter name='restapiUrl' value="`$prop.dmaap-message-router.url + $prop.a1Adapter-dmaap-policy-response.topic`" />
                        <parameter name='format' value='json' />
                        <parameter name='httpMethod' value='POST' />
                        <parameter name='contentType' value='application/json' />
                        <parameter name='responsePrefix' value='dmaap' />
                        <outcome value='failure'>
                            <block>
                                <return status='failure'>
                                    <parameter name='ack-final' value='Y'/>
                                    <parameter name="response-code" value="500" />
                                    <parameter name="response-message" value="Error publishing DMAAP A1 Policy Response message. " />
                                </return>
                            </block>
                        </outcome>
                        <outcome value='success'>
                            <block>
                                <record plugin="org.onap.ccsdk.sli.core.sli.recording.FileRecorder">
                                    <parameter name="file" value="/opt/opendaylight/current/data/log/A1-Adapter.log" />
                                    <parameter name="level" value="info" />
                                    <parameter name="field1" value="DMAAP A1Policy message Successfully Published "/>
                                </record>
                            </block>
                        </outcome>
                    </execute>
                </block>
                <return status='success'>
                    <parameter name="ack-final-indicator" value="Y" />
                    <parameter name="error-code" value="200" />
                    <parameter name="error-message" value="`$error-message`" />
                    <parameter name='response-code' value='200' />
                    <parameter name='response-message' value='getPolicyInstances executed successfully'/>
                    <parameter name='ack-final' value='Y'/>
                </return>
            </block>
        </block>
    </method>
</service-logic>